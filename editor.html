<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="scripts/CalculationEngine.js"></script>
    <script src="scripts/svg.js"></script>
    <script src="scripts/shapes.js"></script>
    <script src="scripts/shape.js"></script>
    <script src="scripts/transformer.js"></script>
    <script src="scripts/selection.js"></script>
    <script src="scripts/miniMap.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/fc365cfb25.js" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/devextreme-dist@24.2.1-alpha-24256-1935/css/dx.fluent.blue.light.compact.css"></script>
    <script src="https://unpkg.com/devextreme-dist@24.2.1-alpha-24256-1935/js/dx.all.debug.js"></script>
    <link rel="stylesheet" type="text/css" href="http://mathquill.com/lib/mathquill.css">
    <script src="http://mathquill.com/lib/mathquill.js"></script>
    <style>
        html, body, .dx-theme-compact {
            font-family: 'Assistant', sans-serif;
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: white;
        }
        
        svg {
            display: block;
            width: 100vw;
            height: 100vh;
            
        }
        
        #menu-container {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
        }

        #toolbar {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 10;
        }
        
        #bottom-toolbar {
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 10;
        }

        #chat-popup {
            display: flex;
            justify-content: center;
        }
        
        .resize-handle {
            fill: white;
            stroke: rgb(165, 216, 255);
            cursor: pointer;
        }

        .rotation-handle {
            fill: white;
            stroke: rgb(165, 216, 255);
            cursor: pointer;
            rx: 5px;
            ry: 5px;
        }
        
        .bounding-box {
            stroke: rgb(165, 216, 255);
            stroke-dasharray: 1;
            fill: transparent;
            cursor: move;
        }
        
        svg.pan-available {
            cursor: grab;
        }
        
        svg:active.pan-available {
            cursor: grabbing;
        }
        
        .minimap-container {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 150px;
            height: 150px;
            border: 1px solid rgba(128, 128, 128, 0.8);
            background-color: rgba(255, 255, 255, 0.8);
        }

        .minimap-container img {
            width: 100%;
            height: 100%;
        }

        @font-face {
            font-family: 'LatinModernMath';
            src: url('fonts/latinmodern-math.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }

        .dx-toolbar-after,
        .dx-toolbar-before,
        .dx-toolbar-center {
            top: 0;
            display: table;
            height: 100%;
            background-color: #fff;
            border-radius: 4px;
            padding-left: 10px;
            padding-right: 10px;
            box-shadow: rgba(0,0,0,.12) 0 2px 7.2px 0,rgba(0,0,0,.14) 0 8px 16px 0;
        }
    </style>
</head>
<body>
    <script>
        DevExpress.config({ licenseKey: "ewogICJmb3JtYXQiOiAxLAogICJjdXN0b21lcklkIjogImNmOWZhNjAzLTI4ZTAtMTFlMi05NWQwLTAwMjE5YjhiNTA0NyIsCiAgIm1heFZlcnNpb25BbGxvd2VkIjogMjQxCn0=.RwzuszxP0EZpb1mjikhmz6G0g5QUrgDILiiRTePC1SeHd3o9co5aGr7mMPuysN6kKb16+UZ0uwtnUXeiOwJcvFTd9wDPT8UqhPXr3uBXmEonDisUwgOBZrfrbZc1satfHazSYg=="});
    </script>
    <svg id="svgCanvas" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
        <rect id="rect" width="100" height="100" fill="lightblue" />
        <circle id="circle" cx="50" cy="50" r="30" fill="coral" />
        <foreignObject id="chart" x="800" y="100" width="200" height="200">
            <div id="chartContainer" style="width: 100%,; height: 100%" xmlns="http://www.w3.org/1999/xhtml"></div>
        </foreignObject>
        <foreignObject id="expression" x="100" y="100" width="200" height="50" id="mathquillObject">
            <div xmlns="http://www.w3.org/1999/xhtml">
                <span id="math-field" class="mq-editable-field mq-math-mode" style="border: 1px solid gray;"></span>
            </div>                
        </foreignObject>
    </svg>
    <div id="toolbar-container">
        <div id="toolbar"></div>
    </div>
    <div id="context-menu"></div>
    <div class="minimap-container">
        <img id="minimap-image" alt="Minimap of the SVG" />
        <div class="viewport" id="minimap-viewport"></div>
    </div>
    <div id="bottom-toolbar-container">
        <div id="bottom-toolbar"></div>
    </div>
    <div id="chat-popup">
    </div>

    <script>
        const system = new Modellus.System("t");
        const parser = new Modellus.Parser(system);
    </script>
        
    <script>
        function getRandomPastelColor() {
            const r = Math.floor((Math.random() * 127) + 127);
            const g = Math.floor((Math.random() * 127) + 127);
            const b = Math.floor((Math.random() * 127) + 127);
            return `rgb(${r},${g},${b})`;
        }

        function getRandomRadius(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        var menuItems = [
            {
                text: 'New',
                icon: 'fa-light fa-file',
                shortcut: 'Ctrl+N'
            },
            {
                text: 'Open...',
                icon: 'fa-light fa-folder',
                shortcut: 'Ctrl+O'
            },
            {
                text: 'Save...',
                icon: 'fa-light fa-arrow-down-to-bracket',
                shortcut: 'Ctrl+S'
            },
            {
                text: 'Close',
                icon: 'fa-light fa-times',
                shortcut: 'Ctrl+W'
            }
        ];
        $("#context-menu").dxContextMenu({
            items: menuItems.map(item => ({
                text: item.text,
                icon: item.icon,
                shortcut: item.shortcut,
                template: function (itemData) {
                    return `<div style="display: flex; justify-content: space-between; align-items: center;width: 100%">
                                <span class="${itemData.icon}" style="width: 15px; margin-right: 10px; text-align: left; display: inline-block"></span>
                                <span style="text-align: left; padding-right: 5px; flex-grow: 1">${itemData.text}</span>
                                <span style="color: #999;">${itemData.shortcut}</span>
                            </div>`;
                }
            })),
            target: "#toolbar",
            position: {
                my: "top left",
                at: "bottom left",
                of: "#menu-button",
                offset: "0 40"
            }
        });
        $("#toolbar").dxToolbar({
            items: [
                {
                    location: "before",
                    widget: "dxButton",
                    options: {
                        icon: "fa-light fa-bars",
                        elementAttr: {
                            id: "menu-button"
                        },
                        onClick: function() {
                            var contextMenu = $("#context-menu").dxContextMenu("instance");
                            contextMenu.show();
                        }
                    }
                },
                {
                    location: "center",
                    widget: "dxButton",
                    options: {
                        elementAttr: {
                            style: "font-family: cursive; font-size: 16px"
                        },
                        text: "X",
                        onClick: function() {
                            const foreignObject = document.createElementNS("http://www.w3.org/2000/svg", "foreignObject");
                            foreignObject.setAttribute("id", "expression");
                            foreignObject.setAttribute("x", "100");
                            foreignObject.setAttribute("y", "100");
                            foreignObject.setAttribute("width", "200");
                            foreignObject.setAttribute("height", "50");
                            const div = document.createElement("div");
                            div.setAttribute("xmlns", "http://www.w3.org/1999/xhtml");
                            const span = document.createElement("span");
                            span.setAttribute("class", "mq-editable-field mq-math-mode");
                            span.style.border = "1px solid gray";
                            div.appendChild(span);
                            foreignObject.appendChild(div);
                            svg.svg.appendChild(foreignObject);
                            new Shape(svg, foreignObject);
                            var MQ = MathQuill.getInterface(2);
                            var mathField = MQ.MathField(span, {
                                spaceBehavesLikeTab: true,
                                handlers: {
                                    edit: function() { 
                                        
                                    }
                                }
                            });
                        }
                    }
                },
                {
                    location: "center",
                    widget: "dxButton",
                    options: {
                        icon: "fa-light fa-circle",
                        onClick: function() {
                            const radius = getRandomRadius(50, 150);
                            const color = getRandomPastelColor();
                            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                            circle.setAttribute('cx', svg.svg.clientWidth / 2);
                            circle.setAttribute('cy', svg.svg.clientHeight / 2);
                            circle.setAttribute('r', radius);
                            circle.setAttribute('fill', color);
                            svg.svg.appendChild(circle);
                            new Shape(svg, circle);
                        }
                    }
                },
                {
                    location: "center",
                    widget: "dxButton",
                    options: {
                        icon: "fa-light fa-arrow-right-long",
                        onClick: function() {
                            alert("Pointer button clicked!");
                        }
                    }
                }
            ]
        });
        $("#bottom-toolbar").dxToolbar({
            items: [
                {
                    widget: "dxButton",
                    options: {
                        icon: "fa-light fa-play",
                        onClick: function () {
                            console.log("Play clicked");
                        }
                    },
                    location: "center"
                },
                {
                    widget: "dxButton",
                    options: {
                        icon: "fa-light fa-pause",
                        onClick: function () {
                            console.log("Pause clicked");
                        }
                    },
                    location: "center"
                },
                {
                    widget: "dxSlider",
                    cssClass: "slider",
                    options: {
                        min: 0,
                        max: 100,
                        value: 0,
                        width: 400,
                        onValueChanged: function (e) {
                            console.log("Slider value:", e.value);
                        }
                    },
                    location: "center"
                },
                {
                    widget: "dxButton",
                    options: {
                        icon: "fa-light fa-stop", 
                        onClick: function () {
                            console.log("Stop clicked");
                        }
                    },
                    location: "center"
                },
                {
                    widget: "dxButton",
                    options: {
                        icon: "fa-light fa-repeat",
                        onClick: function () {
                            console.log("Replay clicked");
                        }
                    },
                    location: "center"
                },
                {
                    widget: "dxButton",
                    options: {
                        icon: "fa-light fa-map",
                        onClick: function () {
                            console.log("Replay clicked");
                        }
                    },
                    location: "after"
                },
                {
                    location: "after",
                    widget: "dxButton",
                    options: {
                        icon: "fa-light fa-robot",
                        elementAttr: {
                            id: "chat-button"
                        },
                        onClick: function() {
                            var chatPopup = $("#chat-popup").dxPopup("instance");
                            chatPopup.show();
                        }
                    }
                }
            ]
        });
        
        function sendToBackend(message, chat) {
            const answer = (message) => {
                setTimeout(() => {
                    chat.renderMessage({
                    text: message, 
                    author: secondUser,
                    timestamp: Date.now() 
                    });
                }, 1000);
            };
        }
        
        $("#chat-popup").dxPopup({
            width: 300,
            height: 400,
            shading: false,
            showTitle: false,
            dragEnabled: false,
            hideOnOutsideClick: true,
            animation: null,
            contentTemplate: function () {
                const firstUser = { id: '1', name: 'User' };
                const secondUser = { id:'2', name: 'Modellus', avatarUrl: 'https://devexpress.github.io/DevExtreme/images/icons/bot.png' };
                const initialMessages = [{
                    timestamp: Date.now(),
                    author: secondUser,
                    text: "Hello! I'm here to help you craft your own model. Ask me to create a model."
                }];
                const $chat = $("<div>").appendTo("#chat-popup");
                const chat = $chat.dxChat({
                    width: "100%",
                    height: "100%", 
                    user: firstUser,
                    onMessageSend: (e) => {
                        sendToBackend(e.message, chat);
                    },
                    items: initialMessages
                });
                return $chat;
            },
            target: "#toolbar",
            position: {
                my: "bottom right",
                at: "top right",
                of: "#chat-button",
                offset: "0 -20"
            }
        });
   </script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var mathFieldSpan = document.getElementById('math-field');
            var MQ = MathQuill.getInterface(2);
            var mathField = MQ.MathField(mathFieldSpan, {
                spaceBehavesLikeTab: true,
                handlers: {
                    edit: function() { 
                        
                    }
                }
            });
            $("#chartContainer").dxChart({
                dataSource: [
                    { day: "Monday", sales: 10 },
                    { day: "Tuesday", sales: 20 },
                    { day: "Wednesday", sales: 30 },
                    { day: "Thursday", sales: 40 },
                    { day: "Friday", sales: 50 }
                ],
                series: {
                    argumentField: "day",
                    valueField: "sales",
                    name: "Sales",
                    type: "bar",
                    color: "#ffaa66"
                }
            });
        });
    </script>

<script>
    var svg = new SVG(document.getElementById("svgCanvas"));
    new Shape(svg, document.getElementById("chart"));
    new Shape(svg, document.getElementById("expression"));
    new Shape(svg, document.getElementById("rect"));
    new Shape(svg, document.getElementById("circle"));
    const selection = new Selection(document.getElementById("svgCanvas"));
    new MiniMap(svg, document.getElementById('minimap-image'), document.getElementById('minimap-viewport'));
</script>
</body>
</html>
